<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Web Ludo — Play with Friends</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; gap:12px; background:#f6f7fb; color:#222; }
    #app { width:100%; max-width:980px; padding:16px; box-sizing:border-box; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; width:100%; }
    .card { background:#fff; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(20,20,50,0.06); }
    #controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, button, select { padding:8px 10px; border-radius:6px; border:1px solid #ddd; font-size:14px; }
    button { cursor:pointer; background:#2563eb; color:white; border:0; }
    button.secondary { background:#efefef; color:#222; border:1px solid #ddd; }
    #board { display:grid; grid-template-columns: repeat(15, 32px); grid-gap:4px; padding:12px; border-radius:10px; }
    .cell { width:32px; height:32px; background:#f3f4f6; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:11px; color:#333; }
    .token { width:20px; height:20px; border-radius:50%; display:inline-block; }
    .token.p0 { background:#ef4444; }
    .token.p1 { background:#16a34a; }
    .token.p2 { background:#f59e0b; }
    .token.p3 { background:#0ea5e9; }
    #log { max-height:220px; overflow:auto; padding:8px; background:#fff; border-radius:8px; width:100%; }
    .small { font-size:13px; color:#666; }
    .center { display:flex; justify-content:center; align-items:center; gap:8px; }
    #playersList { display:flex; gap:8px; flex-wrap:wrap; }
    .playerChip { padding:6px 8px; border-radius:999px; background:#f3f5ff; color:#111; font-weight:600; }
    footer { font-size:12px; color:#666; margin:8px 0 32px; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h2>Web Ludo — Play with Friends (Free)</h2>
      <div class="small">Simple Ludo — Browser only</div>
    </header>

    <section class="card" id="lobby">
      <div id="controls">
        <input id="displayName" placeholder="Your name (optional)" />
        <button id="createBtn">Create Room</button>
        <input id="joinCode" placeholder="Enter room code" style="width:150px"/>
        <button id="joinBtn" class="secondary">Join Room</button>
        <select id="colorPref">
          <option value="auto">Pick token color (auto)</option>
          <option value="0">Red</option>
          <option value="1">Green</option>
          <option value="2">Yellow</option>
          <option value="3">Blue</option>
        </select>
      </div>
      <div style="margin-top:12px" id="roomInfo" class="small"></div>
      <div style="margin-top:12px" id="playersWrap" class="small card" hidden>
        <div><strong>Players</strong></div>
        <div id="playersList"></div>
        <div style="margin-top:8px">
          <button id="startBtn" class="secondary">Start Game (Host)</button>
        </div>
      </div>
    </section>

    <section id="gameArea" hidden>
      <div class="card" style="padding:10px;">
        <div class="center">
          <div><strong>Room:</strong> <span id="roomCodeLabel"></span></div>
          <div id="turnLabel" style="margin-left:12px"></div>
          <div id="diceSection" class="center" style="margin-left:12px">
            <button id="rollBtn">Roll Dice</button>
            <div id="lastRoll" class="small" style="margin-left:8px"></div>
          </div>
        </div>
        <div style="margin-top:12px" id="playersWrapBoard" class="small"></div>
      </div>

      <div style="height:16px"></div>
      <div id="board" class="card"></div>
      <div style="height:8px"></div>
      <div id="log" class="card"></div>
    </section>

    <footer>Tip: Host creates a room and shares the room code. Up to 4 players. Minimal Ludo implementation for quick play.</footer>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

  <!-- Ludo JS -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCMqC5kNq0T_Q0MzryI6U59oCqVFI0z1c8",
      authDomain: "rwsludo.firebaseapp.com",
      databaseURL: "https://rwsludo-default-rtdb.firebaseio.com",
      projectId: "rwsludo",
      storageBucket: "rwsludo.appspot.com",
      messagingSenderId: "199418318279",
      appId: "1:199418318279:web:7ac803f55b081eba1b9de2",
      measurementId: "G-XCKNDK04W5"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // UI helpers
    const $ = id => document.getElementById(id);
    const logEl = $('log');

    function appendLog(txt) {
      const d = document.createElement('div'); d.textContent = txt;
      logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
    }

    const BOARD_SIZE = 52;
    const boardEl = $('board');

    function renderEmptyBoard() {
      boardEl.innerHTML = '';
      for (let i=0; i<BOARD_SIZE; i++) {
        const c = document.createElement('div');
        c.className = 'cell'; c.dataset.idx = i; c.textContent = i+1;
        boardEl.appendChild(c);
      }
    }

    renderEmptyBoard();

    function genRoomCode(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

    // Local session
    let myId = 'p_' + Math.random().toString(36).slice(2,9);
    let myName = '';
    let myColor = null;
    let roomCode = null;
    let roomRef = null;
    let currentRoom = null;
    let amHost = false;

    const createBtn = $('createBtn'), joinBtn = $('joinBtn'), startBtn = $('startBtn'), rollBtn = $('rollBtn');
    const joinCodeInput = $('joinCode'), displayNameInput = $('displayName'), colorPref = $('colorPref');

    createBtn.onclick = async () => {
      myName = displayNameInput.value.trim() || ('Player-' + myId.slice(2,6));
      myColor = colorPref.value === 'auto' ? null : parseInt(colorPref.value);
      roomCode = genRoomCode();
      amHost = true;
      await createRoom(roomCode);
    };

    joinBtn.onclick = async () => {
      myName = displayNameInput.value.trim() || ('Player-' + myId.slice(2,6));
      myColor = colorPref.value === 'auto' ? null : parseInt(colorPref.value);
      roomCode = joinCodeInput.value.trim().toUpperCase();
      if (!roomCode) { alert('Enter room code'); return; }
      await joinRoom(roomCode);
    };

    startBtn.onclick = async () => {
      if (!currentRoom) return;
      const players = Object.keys(currentRoom.players || {});
      if (players.length < 2) { alert('Need at least 2 players'); return; }
      const order = players.slice(0,4);
      const state = { started:true, order, turnIndex:0, lastRoll:null, positions:{}, logs:[] };
      order.forEach(pid => state.positions[pid]=[-1,-1,-1,-1]);
      await roomRef.update({started:true, order, state});
    };

    rollBtn.onclick = async () => {
      if (!currentRoom || !currentRoom.started) return;
      const state = currentRoom.state || {};
      const order = state.order || [];
      const currentPid = order[state.turnIndex];
      if (currentPid !== myId) { alert("Not your turn"); return; }
      const roll = Math.floor(Math.random()*6)+1;
      const posArr = state.positions[myId] || [-1,-1,-1,-1];
      let moved=false;
      if (roll===6){ const idx=posArr.findIndex(p=>p===-1); if(idx!==-1){ posArr[idx]=0; moved=true; } }
      if(!moved){ for(let i=0;i<4;i++){ if(posArr[i]>=0 && posArr[i]<BOARD_SIZE){ posArr[i]+=roll; if(posArr[i]>=BOARD_SIZE) posArr[i]=BOARD_SIZE; moved=true; break; } } }
      state.positions[myId]=posArr;
      state.lastRoll={pid:myId, roll};
      state.logs=state.logs||[]; state.logs.push(`${currentRoom.players[myId].name} rolled ${roll}`);
      state.turnIndex = roll===6 ? state.turnIndex : (state.turnIndex+1)%(state.order.length||1);
      await roomRef.child('state').set(state);
    };

    async function createRoom(code){
      roomCode=code; roomRef=db.ref('rooms/'+roomCode);
      const players={}; players[myId]={name:myName,color:myColor===null?0:myColor,joinedAt:Date.now(),isHost:true};
      const roomObj={players, createdAt:Date.now(), started:false};
      await roomRef.set(roomObj);
      listenRoom();
      $('roomInfo').innerText='Room created: '+roomCode+' — share this code with friends.';
      $('playersWrap').hidden=false; $('roomCodeLabel').innerText=roomCode;
      appendLog('Room created: '+roomCode);
    }

    async function joinRoom(code){
      roomCode=code; roomRef=db.ref('rooms/'+roomCode);
      const snap=await roomRef.once('value'); if(!snap.exists()){ alert('Room not found'); return; }
      const room=snap.val(); const players=room.players||{};
      if(Object.keys(players).length>=4){ alert('Room full (max 4)'); return; }
      let chosen=myColor; if(chosen===null){ const used=new Set(Object.values(players).map(p=>p.color)); chosen=[0,1,2,3].find(c=>!used.has(c)); if(chosen===undefined) chosen=0; }
      players[myId]={name:myName,color:chosen,joinedAt:Date.now(),isHost:false};
      await roomRef.child('players').set(players);
      listenRoom(); $('roomInfo').innerText='Joined room: '+roomCode; $('playersWrap').hidden=false; $('roomCodeLabel').innerText=roomCode;
      appendLog('Joined room: '+roomCode);
    }

    function listenRoom(){
      if(!roomRef) return;
      roomRef.on('value',snap=>{ currentRoom=snap.val(); updatePlayersUI(); updateGameFromRoom(); });
    }

    function updatePlayersUI(){
      const players=currentRoom&&currentRoom.players?currentRoom.players:{}; const list=$('playersList'); list.innerHTML='';
      Object.keys(players).forEach(pid=>{ const p=players[pid]; const div=document.createElement('div'); div.className='playerChip'; div.textContent=p.name+(p.isHost?' (host)':''); list.appendChild(div); if(pid===myId) amHost=!!p.isHost; });
      $('playersWrap').hidden=Object.keys(players).length===0;
      startBtn.style.display=(amHost&&(!currentRoom.started))?'inline-block':'none';
      $('gameArea').hidden=!currentRoom.started;
    }

    function updateGameFromRoom(){
      if(!currentRoom||!currentRoom.started) return;
      $('gameArea').hidden=false;
      const state=currentRoom.state||{}; const order=state.order||[];
      const wrap=$('playersWrapBoard'); wrap.innerHTML='';
      order.forEach((pid,idx)=>{ const p=currentRoom.players[pid]; const el=document.createElement('div'); el.className='small center'; const badge=document.createElement('div'); badge.textContent=(idx===state.turnIndex?'▶':'•')+' '+p.name; badge.style.minWidth='120px'; el.appendChild(badge); wrap.appendChild(el); });
      $('turnLabel').innerText='Turn: '+(currentRoom.players[state.order[state.turnIndex]]?.name||'—');
      $('lastRoll').innerText=state.lastRoll?`Last: ${state.lastRoll.roll} (${currentRoom.players[state.lastRoll.pid]?.name||''})`:'';
      renderBoardPositions(state.positions||{});
      logEl.innerHTML=''; (state.logs||[]).slice(-200).forEach(l=>appendLog(l));
    }

    function renderBoardPositions(positions){
      for(let i=0;i<BOARD_SIZE;i++){ const cell=boardEl.querySelector(`[data-idx="${i}"]`); if(!cell) continue; cell.innerHTML=i+1; }
      if(!positions) return;
      Object.keys(positions).forEach(pid=>{ const arr=positions[pid]; const color=currentRoom.players[pid]?.color??0;
        arr.forEach((p,idxTok)=>{ if(p>=0 && p<BOARD_SIZE){ const cell=boardEl.querySelector(`[data-idx="${p}"]`); if(!cell) return; const t=document.createElement('span'); t.className='token p'+(color%4); t.title=(currentRoom.players[pid]?.name||'')+' #'+(idxTok+1); cell.appendChild(t); } });
      });
    }

    appendLog('Welcome to Web Ludo. Create a room, share code, then have friends join.');
  </script>
</body>
</html>
