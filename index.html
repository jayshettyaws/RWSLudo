<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Web Ludo King Clone</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: sans-serif; display:flex; flex-direction:column; align-items:center; background:#f2f2f2; margin:0; padding:0;}
  #app { max-width:800px; width:100%; padding:10px; }
  #lobby, #gameArea { background:#fff; border-radius:10px; padding:12px; margin-bottom:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);}
  #board { position:relative; width:480px; height:480px; margin:0 auto; display:grid; grid-template-columns:repeat(15,1fr); grid-template-rows:repeat(15,1fr); gap:1px; background:#888;}
  .cell { width:100%; height:100%; background:#f3f3f3; display:flex; justify-content:center; align-items:center; font-size:10px; position:relative;}
  .home0 { background:#ff4d4d;} .home1 { background:#4dff4d;} .home2 { background:#ffff4d;} .home3 { background:#4d4dff;}
  .token { width:28px; height:28px; border-radius:50%; position:absolute; cursor:pointer; z-index:5;}
  .token0 { background:#ff4d4d;} .token1 { background:#4dff4d;} .token2 { background:#ffff4d;} .token3 { background:#4d4dff;}
  #dice { font-size:24px; margin:10px; cursor:pointer; padding:8px 16px; border-radius:6px; border:1px solid #333; background:#fff;}
  #playersList { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
  .playerChip { padding:4px 8px; border-radius:999px; background:#eee; font-weight:600;}
  #log { max-height:150px; overflow:auto; background:#fafafa; padding:6px; margin-top:6px; border-radius:6px; font-size:12px;}
</style>
</head>
<body>
<div id="app">
  <section id="lobby">
    <h2>Web Ludo King Clone</h2>
    <input id="displayName" placeholder="Your Name"/>
    <button id="createRoomBtn">Create Room</button>
    <input id="joinCode" placeholder="Enter Room Code" style="width:120px"/>
    <button id="joinRoomBtn">Join Room</button>
    <div id="roomInfo"></div>
    <div id="playersList"></div>
    <button id="startGameBtn" style="display:none;">Start Game (Host)</button>
  </section>

  <section id="gameArea" style="display:none;">
    <div id="dice">ðŸŽ² Roll</div>
    <div id="turnInfo"></div>
    <div id="board"></div>
    <div id="log"></div>
  </section>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- Variables ---
let myId = 'p_' + Math.random().toString(36).slice(2,9);
let myName = '';
let myColor = null;
let roomCode = null;
let roomRef = null;
let currentRoom = null;
let amHost = false;
let diceRoll = null;

// --- DOM ---
const createRoomBtn = document.getElementById('createRoomBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const startGameBtn = document.getElementById('startGameBtn');
const displayNameInput = document.getElementById('displayName');
const joinCodeInput = document.getElementById('joinCode');
const roomInfo = document.getElementById('roomInfo');
const playersListEl = document.getElementById('playersList');
const gameArea = document.getElementById('gameArea');
const boardEl = document.getElementById('board');
const diceEl = document.getElementById('dice');
const turnInfoEl = document.getElementById('turnInfo');
const logEl = document.getElementById('log');

// --- Board setup ---
const BOARD_SIZE = 52; // path positions (simplified linear)
let cellEls = [];
function renderBoard(){
  boardEl.innerHTML='';
  for(let i=0;i<15*15;i++){
    const div = document.createElement('div');
    div.className='cell';
    boardEl.appendChild(div);
    cellEls.push(div);
  }
}
renderBoard();

// --- Utilities ---
function appendLog(txt){
  const d = document.createElement('div'); d.textContent=txt;
  logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
}
function genRoomCode(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

// --- Room functions ---
createRoomBtn.onclick = async()=>{
  myName = displayNameInput.value || 'Player-'+myId.slice(2,5);
  myColor = 0; amHost=true;
  roomCode = genRoomCode();
  roomRef = db.ref('rooms/'+roomCode);
  const players = {}; players[myId] = {name:myName, color:myColor, isHost:true};
  await roomRef.set({players, started:false});
  roomInfo.innerText = 'Room: '+roomCode;
  startGameBtn.style.display='inline-block';
  listenRoom();
};

joinRoomBtn.onclick=async()=>{
  myName = displayNameInput.value || 'Player-'+myId.slice(2,5);
  roomCode = joinCodeInput.value.trim().toUpperCase();
  if(!roomCode){ alert('Enter room code'); return;}
  roomRef = db.ref('rooms/'+roomCode);
  const snap = await roomRef.once('value');
  if(!snap.exists()){ alert('Room not found'); return;}
  const room = snap.val();
  const players = room.players || {};
  const usedColors = Object.values(players).map(p=>p.color);
  myColor = [0,1,2,3].find(c=>!usedColors.includes(c))||0;
  players[myId]={name:myName, color:myColor, isHost:false};
  await roomRef.child('players').set(players);
  roomInfo.innerText = 'Joined room: '+roomCode;
  listenRoom();
};

startGameBtn.onclick=async()=>{
  if(!currentRoom) return;
  const playerIds = Object.keys(currentRoom.players);
  if(playerIds.length<2){ alert('Need at least 2 players'); return;}
  const state={positions:{}, turnIndex:0, lastRoll:null, logs:[]};
  playerIds.forEach(pid=>state.positions[pid]=[-1,-1,-1,-1]);
  await roomRef.update({started:true,state});
};

// --- Dice ---
diceEl.onclick=async()=>{
  if(!currentRoom||!currentRoom.started) return;
  const state = currentRoom.state;
  if(state.order[state.turnIndex]!==myId){ alert("Not your turn"); return;}
  diceRoll = Math.floor(Math.random()*6)+1;
  appendLog(myName+' rolled '+diceRoll);
  await moveToken(diceRoll);
};

// --- Token movement (click on first movable token) ---
async function moveToken(roll){
  const state = currentRoom.state;
  const posArr = state.positions[myId];
  let moved=false;
  for(let i=0;i<4;i++){
    if(posArr[i]===-1 && roll===6){ posArr[i]=0; moved=true; break;}
    else if(posArr[i]>=0 && posArr[i]<BOARD_SIZE){ posArr[i]+=roll; if(posArr[i]>BOARD_SIZE) posArr[i]=BOARD_SIZE; moved=true; break;}
  }
  if(!moved) { appendLog('No valid move'); return;}
  state.positions[myId]=posArr;
  state.lastRoll={pid:myId, roll};
  // next turn
  let nextIndex = state.turnIndex; if(roll!==6) nextIndex=(state.turnIndex+1)%Object.keys(currentRoom.players).length;
  state.turnIndex = nextIndex;
  await roomRef.child('state').set(state);
}

// --- Listen room updates ---
function listenRoom(){
  if(!roomRef) return;
  roomRef.on('value',snap=>{
    currentRoom = snap.val();
    updateUI();
  });
}

// --- Update UI ---
function updateUI(){
  // Players
  playersListEl.innerHTML='';
  Object.values(currentRoom.players).forEach(p=>{
    const div = document.createElement('div'); div.className='playerChip'; div.textContent=p.name;
    playersListEl.appendChild(div);
  });
  gameArea.style.display = currentRoom.started?'block':'none';
  if(currentRoom.started){
    turnInfoEl.innerText='Turn: '+currentRoom.players[Object.keys(currentRoom.players)[currentRoom.state.turnIndex]].name;
    renderTokens();
  }
}

// --- Render tokens ---
function renderTokens(){
  // clear previous
  document.querySelectorAll('.token').forEach(t=>t.remove());
  const positions = currentRoom.state.positions;
  Object.keys(positions).forEach(pid=>{
    const arr = positions[pid]; const color = currentRoom.players[pid].color;
    arr.forEach((p,i)=>{
      if(p>=0 && p<BOARD_SIZE){
        const cell = cellEls[p]; if(!cell) return;
        const t = document.createElement('div');
        t.className='token token'+color;
        t.style.left='0px'; t.style.top='0px';
        t.title=currentRoom.players[pid].name+' #'+(i+1);
        cell.appendChild(t);
      }
    });
  });
}

appendLog('Welcome to Web Ludo King Clone! Create a room or join one.');
</script>
</body>
</html>
