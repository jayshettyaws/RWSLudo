<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Web Ludo — Play with Friends (Room Code)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Basic layout, compact board UI */
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; gap:12px; background:#f6f7fb; color:#222; }
    #app { width:100%; max-width:980px; padding:16px; box-sizing:border-box; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; width:100%; }
    .card { background:#fff; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(20,20,50,0.06); }
    #controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input, button, select { padding:8px 10px; border-radius:6px; border:1px solid #ddd; font-size:14px; }
    button { cursor:pointer; background:#2563eb; color:white; border:0; }
    button.secondary { background:#efefef; color:#222; border:1px solid #ddd; }
    #board { display:grid; grid-template-columns: repeat(15, 32px); grid-gap:4px; padding:12px; border-radius:10px; }
    .cell { width:32px; height:32px; background:#f3f4f6; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:11px; color:#333; }
    .token { width:20px; height:20px; border-radius:50%; display:inline-block; }
    .token.p0 { background:#ef4444; } /* red */
    .token.p1 { background:#16a34a; } /* green */
    .token.p2 { background:#f59e0b; } /* yellow */
    .token.p3 { background:#0ea5e9; } /* blue */
    #log { max-height:220px; overflow:auto; padding:8px; background:#fff; border-radius:8px; width:100%; }
    .small { font-size:13px; color:#666; }
    .center { display:flex; justify-content:center; align-items:center; gap:8px; }
    #playersList { display:flex; gap:8px; flex-wrap:wrap; }
    .playerChip { padding:6px 8px; border-radius:999px; background:#f3f5ff; color:#111; font-weight:600; }
    .hostBadge { font-size:11px; color:#fff; background:#111; padding:2px 6px; border-radius:6px; margin-left:6px; }
    footer { font-size:12px; color:#666; margin:8px 0 32px; }
  </style>
</head>
<body>
  <div id="app">
    <header>
      <h2>Web Ludo — Play with Friends (Free)</h2>
      <div class="small">Simple Ludo — Browser only</div>
    </header>

    <section class="card" id="lobby">
      <div id="controls">
        <input id="displayName" placeholder="Your name (optional)" />
        <button id="createBtn">Create Room</button>
        <input id="joinCode" placeholder="Enter room code" style="width:150px"/>
        <button id="joinBtn" class="secondary">Join Room</button>
        <select id="colorPref"><option value="auto">Pick token color (auto)</option><option value="0">Red</option><option value="1">Green</option><option value="2">Yellow</option><option value="3">Blue</option></select>
      </div>
      <div style="margin-top:12px" id="roomInfo" class="small"></div>
      <div style="margin-top:12px" id="playersWrap" class="small card" hidden>
        <div><strong>Players</strong></div>
        <div id="playersList"></div>
        <div style="margin-top:8px">
          <button id="startBtn" class="secondary">Start Game (Host)</button>
        </div>
      </div>
    </section>

    <section id="gameArea" hidden>
      <div class="card" style="padding:10px;">
        <div class="center">
          <div><strong>Room:</strong> <span id="roomCodeLabel"></span></div>
          <div id="turnLabel" style="margin-left:12px"></div>
          <div id="diceSection" class="center" style="margin-left:12px">
            <button id="rollBtn">Roll Dice</button>
            <div id="lastRoll" class="small" style="margin-left:8px"></div>
          </div>
        </div>
        <div style="margin-top:12px" id="playersWrapBoard" class="small"></div>
      </div>

      <div style="height:16px"></div>

      <div id="board" class="card"></div>

      <div style="height:8px"></div>
      <div id="log" class="card"></div>
    </section>

    <footer>Tip: Host creates a room and shares the room code. Up to 4 players. This is a minimal Ludo implementation to get you playing fast.</footer>
  </div>

  <!-- Firebase SDKs (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-database-compat.js"></script>

  <script>
    /************* CONFIGURE FIREBASE *************
     * Create a Firebase project, enable Realtime Database,
     * then copy/paste your firebaseConfig object below.
     *
     * firebaseConfig = {
     *   apiKey: "AAA...",
     *   authDomain: "yourproj.firebaseapp.com",
     *   databaseURL: "https://yourproj-default-rtdb.firebaseio.com",
     *   projectId: "yourproj",
     *   storageBucket: "...",
     *   messagingSenderId: "...",
     *   appId: "1:..."
     * };
     **********************************************/
     const firebaseConfig = {
  apiKey: "AIzaSyCMqC5kNq0T_Q0MzryI6U59oCqVFI0z1c8",
  authDomain: "rwsludo.firebaseapp.com",
  databaseURL: "https://rwsludo-default-rtdb.firebaseio.com",
  projectId: "rwsludo",
  storageBucket: "rwsludo.firebasestorage.app",
  messagingSenderId: "199418318279",
  appId: "1:199418318279:web:7ac803f55b081eba1b9de2",
  measurementId: "G-XCKNDK04W5"
};
if (!firebaseConfig || !firebaseConfig.apiKey) {
  console.warn('Please paste your Firebase config into firebaseConfig in the html file.');
}
const app = firebase.initializeApp(firebaseConfig);


    // Initialize Firebase
   
    const db = firebase.database();

    /********* Minimal Ludo Game Model (simplified) *********
     - Up to 4 players (red, green, yellow, blue)
     - Linear track of 52 main squares + home lanes simplified as "home" counts
     - Turn management in room.state
     - Room schema in Realtime DB:
       /rooms/{roomCode} = {
         players: { pid1: {name, color, joinedAt, isHost}, ... },
         order: [pid1,pid2,...],
         started: false,
         state: { positions: {pid: [pos1,pos2,pos3,pos4]}, turnIndex, lastRoll, logs:[] }
       }
    *******************************************************/

    // UI helpers
    const $ = id => document.getElementById(id);
    const logEl = $('log');

    function appendLog(txt){
      const d = document.createElement('div'); d.textContent = txt;
      logEl.appendChild(d); logEl.scrollTop = logEl.scrollHeight;
    }

    // Board setup: we'll make 52 cells (linear numbering) displayed in the grid (simple)
    const BOARD_SIZE = 52; // simplified
    const boardEl = $('board');
    function renderEmptyBoard(){
      boardEl.innerHTML = '';
      for (let i=0;i<BOARD_SIZE;i++){
        const c = document.createElement('div');
        c.className = 'cell'; c.dataset.idx = i;
        c.textContent = i+1;
        boardEl.appendChild(c);
      }
    }
    renderEmptyBoard();

    // Utility: short room code
    function genRoomCode(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

    // Local session
    let myId = 'p_' + Math.random().toString(36).slice(2,9);
    let myName = '';
    let myColor = null; // 0..3
    let roomCode = null;
    let roomRef = null;
    let currentRoom = null;
    let amHost = false;

    // DOM refs
    const createBtn = $('createBtn'), joinBtn = $('joinBtn'), startBtn = $('startBtn'), rollBtn = $('rollBtn');
    const joinCodeInput = $('joinCode'), displayNameInput = $('displayName'), colorPref = $('colorPref');

    createBtn.onclick = async () => {
      myName = displayNameInput.value.trim() || ('Player-' + myId.slice(2,6));
      myColor = colorPref.value === 'auto' ? null : parseInt(colorPref.value);
      roomCode = genRoomCode();
      amHost = true;
      await createRoom(roomCode);
    };

    joinBtn.onclick = async () => {
      myName = displayNameInput.value.trim() || ('Player-' + myId.slice(2,6));
      myColor = colorPref.value === 'auto' ? null : parseInt(colorPref.value);
      roomCode = joinCodeInput.value.trim().toUpperCase();
      if (!roomCode) { alert('Enter room code'); return; }
      await joinRoom(roomCode);
    };

    startBtn.onclick = async () => {
      if (!currentRoom) return;
      const players = Object.keys(currentRoom.players || {});
      if (players.length < 2) { alert('Need at least 2 players to start'); return; }
      // determine order & set initial state
      const order = players.slice(0,4); // keep first joined order (max 4)
      const state = {
        started: true,
        order,
        turnIndex: 0,
        lastRoll: null,
        positions: {}, // each player has array of 4 token pos (-1 = at home)
        logs: []
      };
      order.forEach(pid => state.positions[pid] = [-1,-1,-1,-1]);
      await roomRef.update({started:true, order, state});
    };

    rollBtn.onclick = async () => {
      if (!currentRoom || !currentRoom.started) return;
      const state = currentRoom.state || {};
      const order = state.order || [];
      const currentPid = order[state.turnIndex];
      if (currentPid !== myId) { alert("Not your turn"); return; }
      // roll
      const roll = Math.floor(Math.random()*6) + 1;
      // apply a simple move rule: move first token that is not finished (-1 -> move to 0 on roll 6, else move first movable)
      const posArr = state.positions[myId] || [-1,-1,-1,-1];
      let moved = false;
      if (roll === 6){
        // bring first home token into start (pos 0) if any
        const idx = posArr.findIndex(p => p === -1);
        if (idx !== -1){ posArr[idx] = 0; moved = true; }
      }
      if (!moved){
        // move first token that is >=0 and < BOARD_SIZE
        for (let i=0;i<4;i++){
          if (posArr[i] >= 0 && posArr[i] < BOARD_SIZE){
            posArr[i] = posArr[i] + roll;
            if (posArr[i] >= BOARD_SIZE) posArr[i] = BOARD_SIZE; // reached 'finish'
            moved = true; break;
          }
        }
      }
      state.positions[myId] = posArr;
      state.lastRoll = {pid: myId, roll};
      state.logs = state.logs || [];
      state.logs.push(`${currentRoom.players[myId].name} rolled ${roll}`);
      // next turn: if roll==6 give extra turn, else next player
      let nextIndex = state.turnIndex;
      if (roll !== 6) nextIndex = (state.turnIndex + 1) % (state.order.length || 1);
      state.turnIndex = nextIndex;
      await roomRef.child('state').set(state);
    };

    // Create & join functions
    async function createRoom(code){
      roomCode = code;
      roomRef = db.ref('rooms/' + roomCode);
      const players = {};
      players[myId] = { name: myName, color: myColor === null ? 0 : myColor, joinedAt: Date.now(), isHost:true };
      const roomObj = { players, createdAt: Date.now(), started: false };
      await roomRef.set(roomObj);
      listenRoom();
      $('roomInfo').innerText = 'Room created: ' + roomCode + ' — share this code with friends to join.';
      $('playersWrap').hidden = false;
      $('roomCodeLabel').innerText = roomCode;
      appendLog('Room created: ' + roomCode);
    }

    async function joinRoom(code){
      roomCode = code;
      roomRef = db.ref('rooms/' + roomCode);
      // check exists
      const snap = await roomRef.once('value');
      if (!snap.exists()) { alert('Room not found'); return; }
      // add player (limit 4)
      const room = snap.val();
      const players = room.players || {};
      if (Object.keys(players).length >= 4) { alert('Room full (max 4 players)'); return; }
      // choose color if provided or pick first free
      let chosen = myColor;
      if (chosen === null){
        const used = new Set(Object.values(players).map(p=>p.color));
        chosen = [0,1,2,3].find(c=>!used.has(c));
        if (chosen === undefined) chosen = 0;
      }
      players[myId] = { name: myName, color: chosen, joinedAt: Date.now(), isHost:false };
      await roomRef.child('players').set(players);
      listenRoom();
      $('roomInfo').innerText = 'Joined room: ' + roomCode;
      $('playersWrap').hidden = false;
      $('roomCodeLabel').innerText = roomCode;
      appendLog('Joined room: ' + roomCode);
    }

    function listenRoom(){
      if (!roomRef) return;
      roomRef.on('value', snap => {
        currentRoom = snap.val();
        updatePlayersUI();
        updateGameFromRoom();
      });
    }

    function updatePlayersUI(){
      const players = currentRoom && currentRoom.players ? currentRoom.players : {};
      const list = $('playersList'); list.innerHTML = '';
      Object.keys(players).forEach(pid => {
        const p = players[pid];
        const div = document.createElement('div');
        div.className = 'playerChip';
        div.textContent = p.name + (p.isHost ? ' (host)' : '');
        list.appendChild(div);
        if (pid === myId) {
          amHost = !!p.isHost;
        }
      });
      $('playersWrap').hidden = Object.keys(players).length === 0;
      // show start button only to host and if not started
      startBtn.style.display = (amHost && (!currentRoom.started)) ? 'inline-block' : 'none';
      // reveal game area if started
      $('gameArea').hidden = !currentRoom.started;
    }

    function updateGameFromRoom(){
      if (!currentRoom || !currentRoom.started) {
        // show lobby players
        return;
      }
      // game is running
      $('gameArea').hidden = false;
      const state = currentRoom.state || {};
      const order = state.order || [];
      // show players and turn
      const wrap = $('playersWrapBoard'); wrap.innerHTML = '';
      order.forEach((pid, idx) => {
        const p = currentRoom.players[pid];
        const el = document.createElement('div');
        el.className = 'small center';
        const badge = document.createElement('div'); badge.textContent = (idx===state.turnIndex ? '▶' : '•') + ' ' + p.name;
        badge.style.minWidth='120px';
        el.appendChild(badge);
        wrap.appendChild(el);
      });
      $('turnLabel').innerText = 'Turn: ' + (currentRoom.players[state.order[state.turnIndex]]?.name || '—');
      $('lastRoll').innerText = state.lastRoll ? `Last: ${state.lastRoll.roll} (${currentRoom.players[state.lastRoll.pid]?.name||''})` : '';
      // render tokens on board
      renderBoardPositions(state.positions || {});
      // logs
      logEl.innerHTML = '';
      (state.logs || []).slice(-200).forEach(l => appendLog(l));
    }

    function renderBoardPositions(positions){
      // clear
      for (let i=0;i<BOARD_SIZE;i++){
        const cell = boardEl.querySelector(`[data-idx="${i}"]`);
        if (!cell) continue;
        cell.innerHTML = (i+1);
      }
      // show tokens
      if (!positions) return;
      Object.keys(positions).forEach(pid => {
        const arr = positions[pid];
        const color = currentRoom.players[pid]?.color ?? 0;
        arr.forEach((p, idxTok) => {
          if (p >= 0 && p < BOARD_SIZE){
            const cell = boardEl.querySelector(`[data-idx="${p}"]`);
            if (!cell) return;
            const t = document.createElement('span');
            t.className = 'token p' + (color % 4);
            t.title = (currentRoom.players[pid]?.name || '') + ' #' + (idxTok+1);
            cell.appendChild(t);
          }
        });
      });
    }

    // On page load show small help
    appendLog('Welcome to Web Ludo. Create a room, share code, then have friends join. Host starts the game.');

    // Developer note: make sure firebase config is added; without config, app won't connect.
  </script>
</body>
</html>
