<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Web Ludo Multiplayer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body { font-family: system-ui, sans-serif; background:#f6f7fb; display:flex; flex-direction:column; align-items:center; margin:0; padding:0; }
#app { max-width: 700px; width:100%; padding:16px; }
h2 { margin-bottom:4px; }
#lobby, #gameArea { margin-top:12px; background:#fff; padding:12px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:100%; }
#controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px; }
input, select, button { padding:6px 10px; font-size:14px; border-radius:6px; border:1px solid #ddd; }
button { cursor:pointer; }
button.primary { background:#2563eb; color:#fff; border:0; }
button.secondary { background:#efefef; color:#222; }
#ludoBoard { display:grid; grid-template-columns:repeat(15,40px); grid-template-rows:repeat(15,40px); gap:2px; position:relative; margin-top:12px; }
.cell { width:40px; height:40px; background:#f3f4f6; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:12px; color:#333; position:relative; }
.cell.red { background:#ef4444; } .cell.green { background:#16a34a; } .cell.yellow { background:#f59e0b; } .cell.blue { background:#0ea5e9; }
.token { width:30px; height:30px; border-radius:50%; position:absolute; transition:all 0.5s ease; }
#dice { font-size:30px; cursor:pointer; margin-left:8px; }
#playersList { display:flex; gap:8px; flex-wrap:wrap; margin-top:4px; }
.playerChip { padding:4px 8px; background:#f3f5ff; border-radius:999px; font-weight:600; }
</style>
</head>
<body>
<div id="app">
<h2>Web Ludo Multiplayer</h2>
<div id="lobby">
  <div id="controls">
    <input id="displayName" placeholder="Your name" />
    <button id="createBtn" class="primary">Create Room</button>
    <input id="joinCode" placeholder="Room Code" style="width:100px" />
    <button id="joinBtn" class="secondary">Join Room</button>
    <select id="colorPref">
      <option value="auto">Auto Color</option>
      <option value="0">Red</option>
      <option value="1">Green</option>
      <option value="2">Yellow</option>
      <option value="3">Blue</option>
    </select>
  </div>
  <div id="roomInfo"></div>
  <div id="playersList"></div>
</div>

<div id="gameArea" hidden>
  <div style="display:flex; align-items:center; gap:12px;">
    <div><strong>Room:</strong> <span id="roomCodeLabel"></span></div>
    <div id="turnLabel"></div>
    <button id="rollBtn" class="primary">Roll Dice</button>
    <div id="dice">ðŸŽ²</div>
  </div>
  <div id="ludoBoard"></div>
</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-database-compat.js"></script>

<script>
// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCMqC5kNq0T_Q0MzryI6U59oCqVFI0z1c8",
  authDomain: "rwsludo.firebaseapp.com",
  databaseURL: "https://rwsludo-default-rtdb.firebaseio.com",
  projectId: "rwsludo",
  storageBucket: "rwsludo.firebasestorage.app",
  messagingSenderId: "199418318279",
  appId: "1:199418318279:web:7ac803f55b081eba1b9de2",
  measurementId: "G-XCKNDK04W5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- Board ---
const BOARD_SIZE = 52;
const boardEl = document.getElementById("ludoBoard");
function renderBoard() {
  boardEl.innerHTML = '';
  for(let i=0;i<BOARD_SIZE;i++){
    const c = document.createElement('div');
    c.className='cell';
    c.dataset.idx=i;
    c.textContent=i+1;
    boardEl.appendChild(c);
  }
}
renderBoard();

// --- Local State ---
let myId = 'p_'+Math.random().toString(36).slice(2,8);
let myName = '';
let myColor = null;
let roomCode = null;
let roomRef = null;
let currentRoom = null;
let amHost = false;
const tokens = {0:[],1:[],2:[],3:[]};

// --- UI ---
const $ = id=>document.getElementById(id);
const createBtn=$('createBtn'), joinBtn=$('joinBtn'), rollBtn=$('rollBtn');
const displayNameInput=$('displayName'), joinCodeInput=$('joinCode'), colorPref=$('colorPref');

// --- Room Functions ---
function genRoomCode(){ return Math.random().toString(36).substring(2,8).toUpperCase(); }

async function createRoom(code){
  roomCode = code;
  roomRef = db.ref('rooms/'+roomCode);
  const players = {};
  players[myId]={name:myName, color:myColor===null?0:myColor, isHost:true};
  await roomRef.set({players, started:false, state:{}});
  amHost=true;
  $('roomInfo').innerText = `Room ${roomCode} created. Share code.`;
  $('roomCodeLabel').innerText=roomCode;
  $('gameArea').hidden=false;
  listenRoom();
}

async function joinRoom(code){
  roomCode=code;
  roomRef=db.ref('rooms/'+roomCode);
  const snap=await roomRef.once('value');
  if(!snap.exists()){ alert('Room not found'); return; }
  const room=snap.val();
  const players=room.players||{};
  if(Object.keys(players).length>=4){ alert('Room full'); return; }
  let chosen=myColor;
  if(chosen===null){
    const used=new Set(Object.values(players).map(p=>p.color));
    chosen=[0,1,2,3].find(c=>!used.has(c));
    if(chosen===undefined) chosen=0;
  }
  players[myId]={name:myName,color:chosen,isHost:false};
  await roomRef.child('players').set(players);
  $('roomInfo').innerText = `Joined room ${roomCode}`;
  $('roomCodeLabel').innerText=roomCode;
  $('gameArea').hidden=false;
  listenRoom();
}

function listenRoom(){
  if(!roomRef) return;
  roomRef.on('value',snap=>{
    currentRoom=snap.val();
    updatePlayersUI();
    updateTokens();
  });
}

function updatePlayersUI(){
  const list=$('playersList'); list.innerHTML='';
  const players=currentRoom.players||{};
  Object.keys(players).forEach(pid=>{
    const p=players[pid];
    const div=document.createElement('div');
    div.className='playerChip';
    div.textContent=p.name+(p.isHost?' (host)':'');
    list.appendChild(div);
    if(pid===myId) amHost=p.isHost;
  });
}

// --- Tokens ---
function createTokens(){
  for(let c=0;c<4;c++){
    for(let t=0;t<4;t++){
      const el=document.createElement('div');
      el.className='token t'+c;
      el.id=`token-${c}-${t}`;
      boardEl.appendChild(el);
      tokens[c].push(el);
      setTokenPos(c,t,-1);
    }
  }
}
function setTokenPos(color,idx,pos){
  const t=tokens[color][idx];
  if(pos<0){
    t.style.left=10+idx*35+'px';
    t.style.top=10+idx*35+'px';
  }else{
    const cell=document.querySelector(`[data-idx='${pos}']`);
    if(cell){
      t.style.left=cell.offsetLeft+'px';
      t.style.top=cell.offsetTop+'px';
    }
  }
}
function updateTokens(){
  const state=currentRoom.state||{};
  if(!state.positions) return;
  for(const pid in state.positions){
    const arr=state.positions[pid];
    const color=currentRoom.players[pid].color;
    arr.forEach((pos,idx)=>setTokenPos(color,idx,pos));
  }
  $('turnLabel').innerText='Turn: '+(currentRoom.players[state.turn]?.name||'');
}

// --- Dice & Move ---
rollBtn.onclick=()=>{
  if(!currentRoom || !currentRoom.state) return;
  const state=currentRoom.state;
  const order=Object.keys(currentRoom.players);
  let turn=state.turn||0;
  if(order[turn]!==myId){ alert('Not your turn'); return; }
  const roll=Math.floor(Math.random()*6)+1;
  alert('You rolled '+roll);
  // simple move: move first token not at finish
  const posArr=state.positions?.[myId]||[-1,-1,-1,-1];
  let moved=false;
  for(let i=0;i<4;i++){
    if(posArr[i]<BOARD_SIZE){ posArr[i]+=roll; moved=true; break; }
  }
  if(!state.positions) state.positions={};
  state.positions[myId]=posArr;
  state.turn=(turn+1)%order.length;
  roomRef.child('state').set(state);
};

// --- Init ---
createBtn.onclick=()=>{ myName=displayNameInput.value||'Player'; myColor=colorPref.value==='auto'?null:parseInt(colorPref.value); createRoom(genRoomCode()); };
joinBtn.onclick=()=>{ myName=displayNameInput.value||'Player'; myColor=colorPref.value==='auto'?null:parseInt(colorPref.value); joinRoom(joinCodeInput.value.toUpperCase()); };
window.onload=createTokens;
</script>
</body>
</html>
